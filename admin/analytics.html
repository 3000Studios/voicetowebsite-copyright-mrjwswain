<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VoiceToWebsite | Analytics</title>
    <meta name="description" content="Real-time analytics from Cloudflare and sales endpoints." />
    <meta name="robots" content="noindex, nofollow" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <link rel="stylesheet" href="../styles.css" />
    <link rel="stylesheet" href="./admin.css" />
    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-YOUR_PUBLISHER_ID"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <script>
      (function guardAdmin() {
        const cookie = document.cookie.split(";").some((part) => part.trim().startsWith("vtw_admin=1"));
        const unlocked = sessionStorage.getItem("yt-admin-unlocked") === "true";
        const ts = Number(sessionStorage.getItem("yt-admin-unlocked-ts") || 0);
        const fresh = ts && Date.now() - ts < 1000 * 60 * 60 * 2;

        if (!fresh) {
          sessionStorage.removeItem("yt-admin-unlocked");
          sessionStorage.removeItem("yt-admin-unlocked-ts");
          document.cookie = "vtw_admin=; Path=/; Max-Age=0; SameSite=Lax";
        }

        if (!cookie || !unlocked || !fresh) {
          window.location.href = "/admin/";
        }
      })();
    </script>

    <div class="admin-video-bg" aria-hidden="true">
      <video
        src="https://res.cloudinary.com/dj92eb97f/video/upload/v1768852259/203021-919745637_ftl2bl.mp4"
        autoplay
        muted
        loop
        playsinline
      ></video>
    </div>

    <div class="admin-shell">
      <header class="admin-header">
        <div>
          <h1>Analytics</h1>
          <p>Live stats sourced directly from Cloudflare. No dummy data.</p>
        </div>

        <div class="admin-actions">
          <span class="pill">Edge telemetry</span>
        </div>
      </header>

      <main class="admin-grid">
        <section class="card wide metallic-card">
          <div class="card-head">
            <div>
              <p class="eyebrow">Edge traffic</p>
              <h2>Cloudflare Overview</h2>
              <p class="muted">Requests, bandwidth, threats, and uniques pulled from the Cloudflare Analytics API.</p>
            </div>
            <div class="status-strip">
              <span class="status-chip" id="analytics-status">Loading…</span>
            </div>
          </div>

          <div class="analytics-kpis">
            <div class="metric-card">
              <div class="metric-label">Requests</div>
              <div class="metric-value" id="metric-requests">—</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Bandwidth</div>
              <div class="metric-value" id="metric-bandwidth">—</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Threats</div>
              <div class="metric-value" id="metric-threats">—</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Uniques</div>
              <div class="metric-value" id="metric-uniques">—</div>
            </div>
          </div>

          <div class="table-shell">
            <div class="table-head">
              <h3>Last 12h (timeseries)</h3>
            </div>
            <table class="app-table">
              <thead>
                <tr>
                  <th>Window</th>
                  <th>Requests</th>
                  <th>Bandwidth</th>
                  <th>Threats</th>
                </tr>
              </thead>
              <tbody id="analytics-timeseries">
                <tr>
                  <td colspan="4" class="muted">Loading…</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <section class="card wide metallic-card">
          <div class="card-head">
            <div>
              <p class="eyebrow">Sales</p>
              <h2>Sales & Checkout</h2>
              <p class="muted">
                Connect your payments endpoint to surface real sales data. No mock values are displayed.
              </p>
            </div>
            <div class="status-strip">
              <span class="status-chip" id="sales-status">Not connected</span>
            </div>
          </div>
          <div class="table-shell" id="sales-shell">
            <div class="muted">Loading sales data...</div>
          </div>
        </section>
      </main>
    </div>

    <script type="module" src="../nav.js"></script>
    <script type="module">
      const requestsEl = document.getElementById("metric-requests");
      const bandwidthEl = document.getElementById("metric-bandwidth");
      const threatsEl = document.getElementById("metric-threats");
      const uniquesEl = document.getElementById("metric-uniques");
      const timeseriesEl = document.getElementById("analytics-timeseries");
      const analyticsStatus = document.getElementById("analytics-status");

      const fmtNumber = (n) => (typeof n === "number" ? n.toLocaleString() : "—");
      const fmtBandwidth = (bytes) => {
        if (typeof bytes !== "number") return "—";
        const gb = bytes / (1024 * 1024 * 1024);
        return gb >= 1 ? `${gb.toFixed(2)} GB` : `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
      };

      const renderAnalytics = (result) => {
        const totals = result?.totals || {};
        const requests = totals.requests?.all;
        const bandwidth = totals.bandwidth?.all;
        const threats = totals.threats?.all;
        const uniques = totals.uniques?.all;

        requestsEl.textContent = fmtNumber(requests);
        bandwidthEl.textContent = fmtBandwidth(bandwidth);
        threatsEl.textContent = fmtNumber(threats);
        uniquesEl.textContent = fmtNumber(uniques);

        const ts = result?.timeseries ?? [];
        timeseriesEl.innerHTML = "";

        ts.forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.until || row.since || "window"}</td>
            <td>${fmtNumber(row.requests?.all)}</td>
            <td>${fmtBandwidth(row.bandwidth?.all)}</td>
            <td>${fmtNumber(row.threats?.all)}</td>
          `;
          timeseriesEl.appendChild(tr);
        });

        if (!ts.length) {
          timeseriesEl.innerHTML = '<tr><td colspan="4" class="muted">No analytics timeseries returned.</td></tr>';
        }
      };

      const loadAnalytics = async () => {
        analyticsStatus.textContent = "Loading…";

        // 1. Cloudflare Analytics
        try {
          const res = await fetch("/api/analytics/overview", { cache: "no-store" });
          const data = await res.json();
          if (!res.ok || data?.error) {
            throw new Error(data?.error || "Analytics unavailable");
          }

          renderAnalytics(data.result || {});
          analyticsStatus.textContent = "Live";
          analyticsStatus.classList.add("ok");
        } catch (err) {
          analyticsStatus.textContent = err.message;
          analyticsStatus.classList.add("alert");
        }

        // 2. Sales Analytics
        const salesStatus = document.getElementById("sales-status");
        if (salesStatus) salesStatus.textContent = "Loading...";

        try {
          const res = await fetch("/api/sales/stats", { cache: "no-store" });
          const data = await res.json();

          const shell = document.getElementById("sales-shell");
          if (shell) {
            if (data.recent_orders && data.recent_orders.length > 0) {
              let html = `
                      <table class="app-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Revenue</th>
                                <th>Product</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody>`;
              data.recent_orders.forEach((o) => {
                html += `<tr>
                            <td class="small muted">${o.id}</td>
                            <td>$${Number(o.amount || 0).toFixed(2)}</td>
                            <td>${o.product_id}</td>
                            <td class="small">${new Date(o.ts).toLocaleString()}</td>
                        </tr>`;
              });
              html += `</tbody></table>`;

              // Add summary
              html =
                `<div class="analytics-kpis" style="margin-bottom:1rem;">
                        <div class="metric-card">
                            <div class="metric-label">Total Revenue</div>
                            <div class="metric-value">$${Number(data.total_revenue || 0).toFixed(2)}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Orders</div>
                            <div class="metric-value">${data.total_orders || 0}</div>
                        </div>
                    </div>` + html;

              shell.innerHTML = html;
              if (salesStatus) {
                salesStatus.textContent = "Live";
                salesStatus.classList.add("ok");
              }
            } else {
              shell.innerHTML = `<div class="muted">No sales recorded yet.</div>`;
              if (salesStatus) salesStatus.textContent = "No Data";
            }
          }
        } catch (err) {
          if (salesStatus) {
            salesStatus.textContent = "Error";
            salesStatus.classList.add("alert");
          }
          const shell = document.getElementById("sales-shell");
          if (shell) shell.innerHTML = `<div class="muted alert">Failed to load sales: ${err.message}</div>`;
        }
      };

      loadAnalytics();
    </script>
  </body>
</html>
