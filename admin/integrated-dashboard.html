<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VoiceToWebsite | Integrated Admin Dashboard</title>
    <meta name="description" content="Integrated mission-control dashboard for VoiceToWebsite admin operations." />
    <link rel="stylesheet" href="../styles.css" />
    <link rel="stylesheet" href="./admin.css" />
    <link rel="stylesheet" href="./particle-wallpaper.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --blue: #3b82f6;
        --green: #10b981;
        --amber: #f59e0b;
        --red: #ef4444;
        --text: #e2e8f0;
        --dim: #94a3b8;
        --panel: rgba(10, 18, 35, 0.78);
        --bd: rgba(255, 255, 255, 0.12);
        --shadow: 0 18px 60px rgba(0, 0, 0, 0.45);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        color: var(--text);
        font-family: "Inter", sans-serif;
        background: radial-gradient(circle at 45% 10%, #0f172a 0%, #020617 55%);
      }
      #canvas-background {
        position: fixed;
        inset: 0;
        z-index: 0;
      }
      .vapor-overlay {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 1;
        background:
          radial-gradient(circle at 80% 10%, rgba(30, 64, 175, 0.22), transparent 45%),
          radial-gradient(circle at 15% 85%, rgba(59, 130, 246, 0.16), transparent 40%);
      }
      .admin-particle-wallpaper {
        position: fixed;
        inset: 0;
        z-index: 0;
        opacity: 0.25;
        pointer-events: none;
      }
      .admin-particle-wallpaper iframe {
        width: 100%;
        height: 100%;
        border: 0;
      }
      .app-shell {
        position: relative;
        z-index: 2;
        display: grid;
        grid-template-columns: 74px minmax(0, 1fr);
        min-height: 100vh;
      }
      .nav-rail {
        position: sticky;
        top: 0;
        height: 100vh;
        border-right: 1px solid var(--bd);
        backdrop-filter: blur(10px);
        background: rgba(2, 6, 23, 0.72);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        padding: 16px 0;
      }
      .brand-mark,
      .nav-item,
      .audio-toggle {
        width: 42px;
        height: 42px;
        display: grid;
        place-items: center;
        border-radius: 12px;
      }
      .brand-mark {
        border: 1px solid rgba(59, 130, 246, 0.35);
        background: rgba(30, 58, 138, 0.35);
        font-weight: 800;
        box-shadow: 0 0 16px rgba(59, 130, 246, 0.25);
      }
      .nav-item,
      .audio-toggle {
        border: 1px solid transparent;
        color: var(--dim);
        text-decoration: none;
        background: transparent;
        cursor: pointer;
        transition: 0.16s ease;
      }
      .nav-item:hover,
      .nav-item.active,
      .audio-toggle:hover {
        color: #dbeafe;
        border-color: rgba(59, 130, 246, 0.35);
        background: rgba(59, 130, 246, 0.16);
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
      }
      .status-led {
        margin-top: auto;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: var(--green);
        box-shadow: 0 0 14px var(--green);
      }
      .main {
        padding: 24px;
      }
      .topbar {
        margin-bottom: 18px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 14px;
        align-items: flex-end;
      }
      .topbar h1 {
        margin: 0;
        font-size: clamp(1.5rem, 2vw, 2.2rem);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .topbar p {
        margin: 4px 0 0;
        color: var(--dim);
        font-size: 0.9rem;
      }
      .label {
        color: var(--dim);
        font-size: 0.65rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
      }
      .mono {
        font-family: "JetBrains Mono", monospace;
      }
      .top-stats {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .top-stat {
        min-width: 130px;
        border: 1px solid var(--bd);
        border-radius: 12px;
        padding: 10px 12px;
        background: rgba(15, 23, 42, 0.55);
        box-shadow: var(--shadow);
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(12, minmax(0, 1fr));
        gap: 14px;
      }
      .panel {
        border: 1px solid var(--bd);
        border-radius: 16px;
        padding: 16px;
        background: var(--panel);
        box-shadow: var(--shadow);
        backdrop-filter: blur(14px);
      }
      .col-8 {
        grid-column: span 8;
      }
      .col-4 {
        grid-column: span 4;
      }
      .col-12 {
        grid-column: span 12;
      }
      .panel-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
      }
      .panel-head h2 {
        margin: 0;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .badge {
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid var(--bd);
        font-size: 0.68rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .ok {
        color: #6ee7b7;
        border-color: rgba(16, 185, 129, 0.45);
      }
      .warn {
        color: #fcd34d;
        border-color: rgba(245, 158, 11, 0.45);
      }
      .err {
        color: #fda4af;
        border-color: rgba(239, 68, 68, 0.45);
      }
      .gauge-row {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 14px;
      }
      .gauge-card {
        display: grid;
        place-items: center;
        gap: 8px;
      }
      .gauge-wrap {
        width: 118px;
        height: 118px;
        position: relative;
      }
      .gauge {
        width: 118px;
        height: 118px;
        transform: rotate(-90deg);
      }
      .gauge-bg {
        fill: none;
        stroke-width: 8;
        stroke: rgba(255, 255, 255, 0.08);
      }
      .gauge-meter {
        fill: none;
        stroke-width: 8;
        stroke: var(--blue);
        stroke-linecap: round;
        stroke-dasharray: 251.2;
        stroke-dashoffset: 140;
        filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.8));
        transition: stroke-dashoffset 0.45s ease;
      }
      .gauge-val {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        font-family: "JetBrains Mono", monospace;
      }
      .deploy-actions {
        display: grid;
        gap: 8px;
      }
      .action {
        width: 100%;
        text-align: left;
        border-radius: 12px;
        border: 1px solid var(--bd);
        background: rgba(255, 255, 255, 0.04);
        color: #dbeafe;
        padding: 11px;
        cursor: pointer;
        transition: 0.16s ease;
      }
      .action:hover {
        border-color: rgba(59, 130, 246, 0.45);
        background: rgba(59, 130, 246, 0.18);
      }
      .cards {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 10px;
      }
      .kpi {
        border: 1px solid var(--bd);
        background: rgba(255, 255, 255, 0.03);
        border-radius: 12px;
        padding: 12px;
      }
      .kpi-value {
        margin-top: 8px;
        font-size: 1.4rem;
        font-weight: 800;
      }
      .stream {
        display: grid;
        gap: 8px;
        max-height: 280px;
        overflow: auto;
        padding-right: 4px;
      }
      .stream-item {
        border-left: 2px solid rgba(59, 130, 246, 0.4);
        padding: 8px 10px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 0 8px 8px 0;
      }
      .stream-meta {
        color: var(--dim);
        font-size: 0.72rem;
        margin-top: 4px;
      }
      .service-list {
        display: grid;
        gap: 10px;
      }
      .service {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        padding-bottom: 8px;
      }
      .service:last-child {
        border-bottom: 0;
      }
      .light {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        margin-right: 8px;
        display: inline-block;
      }
      .green {
        background: var(--green);
        box-shadow: 0 0 10px var(--green);
      }
      .amber {
        background: var(--amber);
        box-shadow: 0 0 10px var(--amber);
      }
      .red {
        background: var(--red);
        box-shadow: 0 0 10px var(--red);
      }
      .media-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 10px;
      }
      .media-card {
        text-decoration: none;
        color: inherit;
        border: 1px solid var(--bd);
        border-radius: 12px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.03);
      }
      .media-card video {
        width: 100%;
        height: 136px;
        object-fit: cover;
        display: block;
      }
      .media-body {
        padding: 10px;
      }
      .section-links {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }
      .section-link {
        border-radius: 12px;
        border: 1px solid var(--bd);
        background: rgba(255, 255, 255, 0.03);
        padding: 10px;
        text-decoration: none;
        color: #dbeafe;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .section-link:hover {
        border-color: rgba(59, 130, 246, 0.4);
        background: rgba(59, 130, 246, 0.12);
      }
      .status-line {
        display: flex;
        justify-content: space-between;
        margin-top: 6px;
        font-size: 0.86rem;
      }
      .sound-label {
        font-size: 0.62rem;
        text-transform: uppercase;
        color: var(--dim);
      }
      @media (max-width: 1200px) {
        .col-8,
        .col-4 {
          grid-column: span 12;
        }
        .cards {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .media-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      @media (max-width: 900px) {
        .app-shell {
          grid-template-columns: 1fr;
        }
        .nav-rail {
          height: auto;
          position: sticky;
          top: 0;
          z-index: 30;
          border-right: 0;
          border-bottom: 1px solid var(--bd);
          flex-direction: row;
          justify-content: flex-start;
          padding: 10px;
          overflow-x: auto;
        }
        .status-led {
          margin-top: 0;
          margin-left: auto;
          margin-right: 10px;
        }
        .main {
          padding: 16px;
        }
        .gauge-row,
        .section-links,
        .cards,
        .media-grid {
          grid-template-columns: 1fr;
        }
      }
      @media (prefers-reduced-motion: reduce) {
        * {
          animation: none !important;
          transition: none !important;
        }
      }
    </style>
  </head>
  <body>
    <canvas id="canvas-background"></canvas>
    <div class="vapor-overlay" aria-hidden="true"></div>
    <div class="admin-particle-wallpaper" aria-hidden="true"><iframe src="./wallpaper.html"></iframe></div>

    <div class="app-shell">
      <nav class="nav-rail" aria-label="Admin Mission Navigation">
        <div class="brand-mark" aria-hidden="true">VTW</div>
        <a class="nav-item active" href="/admin/integrated-dashboard.html" title="Mission Control">MC</a>
        <a class="nav-item" href="/admin/index.html" title="Command Center">CC</a>
        <a class="nav-item" href="/admin/voice-commands.html" title="Voice">VC</a>
        <a class="nav-item" href="/admin/test-lab-1.html" title="Agent">AG</a>
        <a class="nav-item" href="/admin/analytics.html" title="Analytics">AN</a>
        <a class="nav-item" href="/admin/store-manager.html" title="Store">ST</a>
        <a class="nav-item" href="/admin/app-store-manager.html" title="Apps">AP</a>
        <a class="nav-item" href="/admin/customer-chat.html" title="Chat">CH</a>
        <a class="nav-item" href="/admin/live-stream.html" title="Live">LV</a>
        <a class="nav-item" href="/admin/nexus.html" title="Nexus">NX</a>
        <button class="audio-toggle" id="audio-toggle" type="button" title="Toggle sound">SFX</button>
        <div class="status-led" id="global-led" title="Global status"></div>
      </nav>

      <main class="main">
        <header class="topbar">
          <div>
            <p class="label">Node: Admin / Mission Control / Production</p>
            <h1>Ionized Cobalt Mission Control</h1>
            <p>Visual ops center for voice, deploy, commerce, and system health.</p>
          </div>
          <div class="top-stats">
            <div class="top-stat">
              <div class="label">Auth</div>
              <div class="mono" id="auth-status">Checking...</div>
            </div>
            <div class="top-stat">
              <div class="label">Orchestrator</div>
              <div class="mono" id="orchestrator-status">--</div>
            </div>
            <div class="top-stat">
              <div class="label">Deploy</div>
              <div class="mono" id="deploy-status">Idle</div>
            </div>
            <div class="top-stat">
              <div class="label">Last Refresh</div>
              <div class="mono" id="refresh-ts">--:--:--</div>
            </div>
          </div>
        </header>

        <section class="grid">
          <article class="panel col-8">
            <div class="panel-head">
              <h2>System Topology</h2>
              <span class="badge ok" id="env-badge">Production Synced</span>
            </div>
            <div class="gauge-row">
              <div class="gauge-card">
                <div class="gauge-wrap">
                  <svg class="gauge" viewBox="0 0 100 100" aria-hidden="true">
                    <circle class="gauge-bg" cx="50" cy="50" r="40"></circle>
                    <circle class="gauge-meter" id="gauge-traffic" cx="50" cy="50" r="40"></circle>
                  </svg>
                  <div class="gauge-val" id="gauge-traffic-val">0%</div>
                </div>
                <div class="label">Traffic Load</div>
              </div>
              <div class="gauge-card">
                <div class="gauge-wrap">
                  <svg class="gauge" viewBox="0 0 100 100" aria-hidden="true">
                    <circle class="gauge-bg" cx="50" cy="50" r="40"></circle>
                    <circle class="gauge-meter" id="gauge-unique" cx="50" cy="50" r="40"></circle>
                  </svg>
                  <div class="gauge-val" id="gauge-unique-val">0%</div>
                </div>
                <div class="label">Unique Ratio</div>
              </div>
              <div class="gauge-card">
                <div class="gauge-wrap">
                  <svg class="gauge" viewBox="0 0 100 100" aria-hidden="true">
                    <circle class="gauge-bg" cx="50" cy="50" r="40"></circle>
                    <circle class="gauge-meter" id="gauge-deploy" cx="50" cy="50" r="40"></circle>
                  </svg>
                  <div class="gauge-val" id="gauge-deploy-val">0%</div>
                </div>
                <div class="label">Deploy Health</div>
              </div>
            </div>
          </article>

          <article class="panel col-4">
            <div class="panel-head">
              <h2>Deploy Rail</h2>
              <span class="badge warn" id="build-status-badge">Idle</span>
            </div>
            <div class="deploy-actions">
              <button class="action" data-route="/admin/voice-commands.html">
                <strong>Push via Voice Flow</strong>
                <div class="label">Plan - Apply - Deploy</div>
              </button>
              <button class="action" data-route="/admin/index.html#plan">
                <strong>Open Command Center</strong>
                <div class="label">Structured edit + preview</div>
              </button>
              <button class="action" data-route="/admin/progress.html">
                <strong>Review Progress</strong>
                <div class="label">Milestones + blockers</div>
              </button>
              <button class="action" id="view-raw-logs" type="button">
                <strong>View Raw Logs</strong>
                <div class="label">Open /admin/logs</div>
              </button>
            </div>
          </article>

          <article class="panel col-12">
            <div class="cards">
              <div class="kpi">
                <div class="label">Requests (12h)</div>
                <div class="kpi-value mono" id="kpi-requests">--</div>
              </div>
              <div class="kpi">
                <div class="label">Uniques (12h)</div>
                <div class="kpi-value mono" id="kpi-uniques">--</div>
              </div>
              <div class="kpi">
                <div class="label">Products</div>
                <div class="kpi-value mono" id="kpi-products">--</div>
              </div>
              <div class="kpi">
                <div class="label">Sound</div>
                <div class="kpi-value mono" id="kpi-sound">OFF</div>
                <div class="sound-label">User-toggleable</div>
              </div>
            </div>
          </article>

          <article class="panel col-8">
            <div class="panel-head">
              <h2>Event Stream</h2>
              <span class="badge" id="stream-count">0 events</span>
            </div>
            <div class="stream" id="event-stream"><div class="stream-item">No activity yet.</div></div>
          </article>

          <article class="panel col-4">
            <div class="panel-head">
              <h2>API Service Lights</h2>
              <span class="badge" id="service-badge">Checking</span>
            </div>
            <div class="service-list" id="service-list">
              <div class="service">
                <span>Health</span><span><i class="light amber"></i>Checking</span>
              </div>
              <div class="service">
                <span>Analytics</span><span><i class="light amber"></i>Checking</span>
              </div>
              <div class="service">
                <span>Products</span><span><i class="light amber"></i>Checking</span>
              </div>
              <div class="service">
                <span>Bots</span><span><i class="light amber"></i>Checking</span>
              </div>
              <div class="service">
                <span>Logs</span><span><i class="light amber"></i>Checking</span>
              </div>
            </div>
            <div class="status-line"><span>Uptime</span><strong class="mono" id="uptime">--</strong></div>
            <div class="status-line"><span>D1</span><strong class="mono" id="d1-status">--</strong></div>
            <div class="status-line"><span>Assets</span><strong class="mono" id="assets-status">--</strong></div>
          </article>

          <article class="panel col-12">
            <div class="panel-head">
              <h2>Visual Route Map</h2>
              <span class="badge ok">All sections routeable</span>
            </div>
            <div class="media-grid">
              <a class="media-card" href="/admin/voice-commands.html"
                ><video src="/media/vtw-animated-logo.mp4" autoplay muted loop playsinline></video>
                <div class="media-body">
                  <strong>Voice Command Center</strong>
                  <div class="label">Speak updates and ship</div>
                </div></a
              >
              <a class="media-card" href="/admin/test-lab-1.html"
                ><video src="/media/vtw-home-wallpaper.mp4" autoplay muted loop playsinline></video>
                <div class="media-body">
                  <strong>Agent Ops</strong>
                  <div class="label">Autonomy + remote control</div>
                </div></a
              >
              <a class="media-card" href="/admin/index.html"
                ><video src="/media/vtw-opener.mp4" autoplay muted loop playsinline></video>
                <div class="media-body">
                  <strong>Command Center</strong>
                  <div class="label">Plan, preview, apply, deploy</div>
                </div></a
              >
            </div>
          </article>

          <article class="panel col-12">
            <div class="panel-head">
              <h2>All Sections</h2>
              <button class="action" id="manual-refresh" type="button">Refresh Data</button>
            </div>
            <div class="section-links">
              <a class="section-link" href="/admin/index.html"><span>Command Center</span><span>-&gt;</span></a>
              <a class="section-link" href="/admin/voice-commands.html"
                ><span>Voice Commands</span><span>-&gt;</span></a
              >
              <a class="section-link" href="/admin/test-lab-1.html"><span>Agent Control</span><span>-&gt;</span></a>
              <a class="section-link" href="/admin/analytics.html"><span>Analytics</span><span>-&gt;</span></a>
              <a class="section-link" href="/admin/store-manager.html"><span>Store Manager</span><span>-&gt;</span></a>
              <a class="section-link" href="/admin/app-store-manager.html"
                ><span>App Store Manager</span><span>-&gt;</span></a
              >
              <a class="section-link" href="/admin/customer-chat.html"><span>Customer Chat</span><span>-&gt;</span></a>
              <a class="section-link" href="/admin/live-stream.html"><span>Live Stream</span><span>-&gt;</span></a>
              <a class="section-link" href="/admin/nexus.html"><span>Nexus</span><span>-&gt;</span></a>
              <a class="section-link" href="/admin/progress.html"><span>Progress</span><span>-&gt;</span></a>
              <a class="section-link" href="/admin/bot-command-center.html"><span>Boss Bot</span><span>-&gt;</span></a>
              <a class="section-link" href="/"><span>Public Site</span><span>-&gt;</span></a>
            </div>
          </article>
        </section>
      </main>
    </div>

    <script type="module" src="./access-guard.js"></script>
    <script>
      const circumference = 251.2;
      const refreshEveryMs = 30000;
      const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;

      const ui = {
        authStatus: document.getElementById("auth-status"),
        orchestratorStatus: document.getElementById("orchestrator-status"),
        deployStatus: document.getElementById("deploy-status"),
        refreshTs: document.getElementById("refresh-ts"),
        envBadge: document.getElementById("env-badge"),
        buildStatusBadge: document.getElementById("build-status-badge"),
        requests: document.getElementById("kpi-requests"),
        uniques: document.getElementById("kpi-uniques"),
        products: document.getElementById("kpi-products"),
        sound: document.getElementById("kpi-sound"),
        stream: document.getElementById("event-stream"),
        streamCount: document.getElementById("stream-count"),
        serviceList: document.getElementById("service-list"),
        serviceBadge: document.getElementById("service-badge"),
        uptime: document.getElementById("uptime"),
        d1Status: document.getElementById("d1-status"),
        assetsStatus: document.getElementById("assets-status"),
        globalLed: document.getElementById("global-led"),
      };

      const gauges = {
        traffic: {
          meter: document.getElementById("gauge-traffic"),
          value: document.getElementById("gauge-traffic-val"),
        },
        unique: { meter: document.getElementById("gauge-unique"), value: document.getElementById("gauge-unique-val") },
        deploy: { meter: document.getElementById("gauge-deploy"), value: document.getElementById("gauge-deploy-val") },
      };
      const formatNumber = (value) =>
        typeof value === "number" && Number.isFinite(value) ? value.toLocaleString() : "--";
      const statusTag = (ok, warnText = "Warn") =>
        ok === true
          ? { cls: "green", text: "OK" }
          : ok === false
            ? { cls: "red", text: "Down" }
            : { cls: "amber", text: warnText };
      const setGauge = (gauge, percentage) => {
        const pct = Math.max(0, Math.min(100, Math.round(percentage || 0)));
        gauge.meter.style.strokeDashoffset = String(circumference - (circumference * pct) / 100);
        gauge.value.textContent = `${pct}%`;
      };
      const setBadge = (el, text, state) => {
        el.textContent = text;
        el.classList.remove("ok", "warn", "err");
        if (state === "ok") el.classList.add("ok");
        else if (state === "warn") el.classList.add("warn");
        else if (state === "err") el.classList.add("err");
      };
      const setLed = (state) => {
        ui.globalLed.style.background =
          state === "ok" ? "var(--green)" : state === "warn" ? "var(--amber)" : "var(--red)";
        ui.globalLed.style.boxShadow =
          state === "ok" ? "0 0 14px var(--green)" : state === "warn" ? "0 0 14px var(--amber)" : "0 0 14px var(--red)";
      };
      const fetchJson = async (url) => {
        try {
          const res = await fetch(url, { cache: "no-store", credentials: "include" });
          if (!res.ok) return null;
          return await res.json();
        } catch (_) {
          return null;
        }
      };

      const renderServiceLights = (statusMap) => {
        const lines = [
          ["Health", statusMap.health],
          ["Analytics", statusMap.analytics],
          ["Products", statusMap.products],
          ["Bots", statusMap.bots],
          ["Logs", statusMap.logs],
        ];
        ui.serviceList.innerHTML = lines
          .map(([name, state]) => {
            const tag = statusTag(state, "Checking");
            return `<div class="service"><span>${name}</span><span><i class="light ${tag.cls}"></i>${tag.text}</span></div>`;
          })
          .join("");
        const allOk = lines.every(([, state]) => state === true);
        const anyDown = lines.some(([, state]) => state === false);
        setBadge(
          ui.serviceBadge,
          allOk ? "Healthy" : anyDown ? "Issues" : "Checking",
          allOk ? "ok" : anyDown ? "err" : "warn"
        );
        setLed(allOk ? "ok" : anyDown ? "err" : "warn");
      };

      const renderLogs = (logs) => {
        if (!Array.isArray(logs) || logs.length === 0) {
          ui.stream.innerHTML = '<div class="stream-item">No activity yet.</div>';
          ui.streamCount.textContent = "0 events";
          return;
        }
        ui.stream.innerHTML = logs
          .slice(0, 12)
          .map((log) => {
            const ts = log.ts ? new Date(log.ts).toLocaleString() : "Unknown time";
            return `<div class="stream-item"><div>${log.command || "(no command)"}</div><div class="stream-meta">${ts}</div></div>`;
          })
          .join("");
        ui.streamCount.textContent = `${Math.min(logs.length, 12)} events`;
      };

      const deriveGaugeValues = (analytics, bots) => {
        const requests = analytics?.result?.totals?.requests?.all || 0;
        const uniques = analytics?.result?.totals?.uniques?.all || 0;
        const traffic = Math.min(100, Math.round((requests / 5000) * 100));
        const uniqueRatio = requests > 0 ? Math.round((uniques / requests) * 100) : 0;
        const buildStatus = bots?.builds?.[0]?.status || "idle";
        const deploy = /ok|success|deployed|completed/i.test(buildStatus)
          ? 94
          : /fail|error|rollback/i.test(buildStatus)
            ? 24
            : 68;
        return { traffic, uniqueRatio, deploy };
      };

      const routeButtons = () => {
        document.querySelectorAll("[data-route]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const route = btn.getAttribute("data-route");
            if (route) window.location.href = route;
          });
        });
      };

      const initAudio = () => {
        const btn = document.getElementById("audio-toggle");
        const key = "vtw-admin-audio-enabled";
        let enabled = localStorage.getItem(key) === "true";
        let ctx = null;
        const beep = (freq, duration) => {
          if (!enabled) return;
          try {
            ctx = ctx || new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.frequency.value = freq;
            gain.gain.value = 0.08;
            gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + duration);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + duration);
          } catch (_) {
            enabled = false;
          }
        };
        const render = () => {
          ui.sound.textContent = enabled ? "ON" : "OFF";
          btn.textContent = enabled ? "SFX ON" : "SFX OFF";
        };
        btn.addEventListener("click", () => {
          enabled = !enabled;
          localStorage.setItem(key, String(enabled));
          render();
          beep(660, 0.06);
        });
        render();
        return { beep };
      };

      const initBackground = () => {
        const canvas = document.getElementById("canvas-background");
        const ctx = canvas.getContext("2d");
        const particles = [];
        const reset = () => {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
          particles.length = 0;
          const count = Math.max(20, Math.floor(window.innerWidth / 40));
          for (let i = 0; i < count; i += 1) {
            particles.push({
              x: Math.random() * canvas.width,
              y: Math.random() * canvas.height,
              size: Math.random() * 1.8 + 0.4,
              vy: Math.random() * 0.42 + 0.08,
              alpha: Math.random() * 0.45 + 0.05,
            });
          }
        };
        const tick = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          particles.forEach((p) => {
            ctx.globalAlpha = p.alpha;
            ctx.fillStyle = "#3b82f6";
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            ctx.fill();
            p.y -= p.vy;
            if (p.y < -5) p.y = canvas.height + 5;
          });
          requestAnimationFrame(tick);
        };
        reset();
        if (!prefersReducedMotion) tick();
        window.addEventListener("resize", reset);
      };

      const startUptime = () => {
        const start = Date.now();
        window.setInterval(() => {
          const sec = Math.floor((Date.now() - start) / 1000);
          const hrs = String(Math.floor(sec / 3600)).padStart(2, "0");
          const mins = String(Math.floor((sec % 3600) / 60)).padStart(2, "0");
          const s = String(sec % 60).padStart(2, "0");
          ui.uptime.textContent = `00:${hrs}:${mins}:${s}`;
        }, 1000);
      };

      const refreshData = async (audio) => {
        const [health, analytics, products, bots, logsPayload] = await Promise.all([
          fetchJson("/api/health"),
          fetchJson("/api/analytics/overview"),
          fetchJson("/api/products"),
          fetchJson("/api/bots/status"),
          fetchJson("/admin/logs"),
        ]);
        const checks = {
          health: !!health,
          analytics: !!analytics,
          products: !!products,
          bots: !!bots,
          logs: !!logsPayload,
        };
        renderServiceLights(checks);
        ui.authStatus.textContent = health?.status === "ok" ? "Unlocked" : "Locked";
        ui.orchestratorStatus.textContent = health?.orchestrator || "unknown";
        ui.deployStatus.textContent = bots?.builds?.[0]?.status || "idle";
        ui.refreshTs.textContent = new Date().toLocaleTimeString();
        ui.requests.textContent = formatNumber(analytics?.result?.totals?.requests?.all);
        ui.uniques.textContent = formatNumber(analytics?.result?.totals?.uniques?.all);
        ui.products.textContent = formatNumber((products?.products || []).length);
        const gaugeVals = deriveGaugeValues(analytics, bots);
        setGauge(gauges.traffic, gaugeVals.traffic);
        setGauge(gauges.unique, gaugeVals.uniqueRatio);
        setGauge(gauges.deploy, gaugeVals.deploy);
        ui.d1Status.textContent = health?.d1 === true ? "Connected" : health?.d1 === false ? "Unavailable" : "--";
        ui.assetsStatus.textContent = health?.assets === true ? "Serving" : health?.assets === false ? "Down" : "--";
        const buildStatus = bots?.builds?.[0]?.status || "Idle";
        const buildState = /ok|success|deployed|completed/i.test(buildStatus)
          ? "ok"
          : /fail|error|rollback/i.test(buildStatus)
            ? "err"
            : "warn";
        setBadge(ui.buildStatusBadge, buildStatus, buildState);
        setBadge(
          ui.envBadge,
          health?.status === "ok" ? "Production Synced" : "Auth Required",
          health?.status === "ok" ? "ok" : "warn"
        );
        renderLogs(Array.isArray(logsPayload?.logs) ? logsPayload.logs : []);
        if (checks.health && checks.analytics && checks.products && checks.bots && checks.logs) audio.beep(740, 0.03);
      };

      const init = () => {
        initBackground();
        startUptime();
        routeButtons();
        const audio = initAudio();
        document.getElementById("manual-refresh").addEventListener("click", () => refreshData(audio));
        document.getElementById("view-raw-logs").addEventListener("click", () => window.open("/admin/logs", "_blank"));
        refreshData(audio);
        window.setInterval(() => refreshData(audio), refreshEveryMs);
      };

      init();
    </script>
  </body>
</html>
